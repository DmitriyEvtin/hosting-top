# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å Email API

## –û–±–∑–æ—Ä

Email API —Ä–æ—É—Ç—ã –∑–∞—â–∏—â–µ–Ω—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º.

## –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### 1. `/api/email/send` (POST)

- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—Å—Ç—ã—Ö email —Å–æ–æ–±—â–µ–Ω–∏–π
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è**: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è + –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- **–°—Ç–∞—Ç—É—Å –∫–æ–¥—ã**:
  - `401 Unauthorized` - –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
  - `403 Forbidden` - –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  - `503 Service Unavailable` - email —Å–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
  - `400 Bad Request` - –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  - `500 Internal Server Error` - –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏

### 2. `/api/email/template` (POST)

- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Ç–ø—Ä–∞–≤–∫–∞ email –ø–æ —à–∞–±–ª–æ–Ω–∞–º
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è**: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è + –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- **–°—Ç–∞—Ç—É—Å –∫–æ–¥—ã**:
  - `401 Unauthorized` - –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
  - `403 Forbidden` - –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  - `404 Not Found` - —à–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω
  - `503 Service Unavailable` - email —Å–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
  - `400 Bad Request` - –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  - `500 Internal Server Error` - –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏

### 3. `/api/email/status` (GET)

- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ email —Å–µ—Ä–≤–∏—Å–∞
- **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è**: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–ª—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- **–°—Ç–∞—Ç—É—Å –∫–æ–¥—ã**:
  - `401 Unauthorized` - –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
  - `200 OK` - —Å—Ç–∞—Ç—É—Å –ø–æ–ª—É—á–µ–Ω
  - `500 Internal Server Error` - –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

## –£—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞

### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã (ADMIN)

- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—Å—Ç—ã—Ö email
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ email –ø–æ —à–∞–±–ª–æ–Ω–∞–º
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ email —Å–µ—Ä–≤–∏—Å–∞
- ‚úÖ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ email —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (USER)

- ‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ email (–∑–∞–ø—Ä–µ—â–µ–Ω–æ)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ email —Å–µ—Ä–≤–∏—Å–∞
- ‚ùå –î–æ—Å—Ç—É–ø –∫ email —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω

### –ù–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

- ‚ùå –î–æ—Å—Ç—É–ø –∫ –ª—é–±—ã–º email API –∑–∞–ø—Ä–µ—â–µ–Ω
- ‚ùå –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 401 Unauthorized

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)

```bash
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (—á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ API)
curl -X POST http://localhost:3000/api/auth/signin \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"password"}'

# –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ email
curl -X POST http://localhost:3000/api/email/send \
  -H "Content-Type: application/json" \
  -H "Cookie: next-auth.session-token=your-session-token" \
  -d '{
    "to": "user@example.com",
    "subject": "Test Email",
    "text": "This is a test message",
    "html": "<p>This is a <strong>test message</strong></p>"
  }'

# –û—Ç–ø—Ä–∞–≤–∫–∞ email –ø–æ —à–∞–±–ª–æ–Ω—É
curl -X POST http://localhost:3000/api/email/template \
  -H "Content-Type: application/json" \
  -H "Cookie: next-auth.session-token=your-session-token" \
  -d '{
    "template": "welcome",
    "to": "user@example.com",
    "data": {
      "userName": "John Doe",
      "loginUrl": "http://localhost:3000/auth/signin"
    }
  }'
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–¥–ª—è –≤—Å–µ—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö)

```bash
curl -X GET http://localhost:3000/api/email/status \
  -H "Cookie: next-auth.session-token=your-session-token"
```

## –û—à–∏–±–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```bash
curl -X POST http://localhost:3000/api/email/send \
  -H "Content-Type: application/json" \
  -d '{"to":"test@example.com","subject":"Test","text":"Test"}'

# –û—Ç–≤–µ—Ç: {"error":"Unauthorized"}
# –°—Ç–∞—Ç—É—Å: 401
```

### –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

```bash
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ä–æ–ª—å—é USER –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email
curl -X POST http://localhost:3000/api/email/send \
  -H "Content-Type: application/json" \
  -H "Cookie: next-auth.session-token=user-session-token" \
  -d '{"to":"test@example.com","subject":"Test","text":"Test"}'

# –û—Ç–≤–µ—Ç: {"error":"Forbidden. Admin access required."}
# –°—Ç–∞—Ç—É—Å: 403
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ email API –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```bash
# –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
[INFO] Email sent successfully by admin@example.com to user@example.com

# –ù–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞
[WARN] Unauthorized email API access attempt from IP 192.168.1.100
[WARN] Forbidden email API access attempt by user@example.com (role: USER)
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ü–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–∏—Å–µ–º –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
- –ü–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ —Å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. –†–µ–≥—É–ª—è—Ä–Ω—ã–π –∞—É–¥–∏—Ç –¥–æ—Å—Ç—É–ø–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
grep "Unauthorized\|Forbidden" /var/log/app.log

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–∏—Å–µ–º
grep "Email sent successfully" /var/log/app.log | wc -l
```

### 2. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ø–∞–º–∞:

```typescript
// –ü—Ä–∏–º–µ—Ä middleware –¥–ª—è rate limiting
const rateLimit = {
  windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
  max: 10, // –º–∞–∫—Å–∏–º—É–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–∫–Ω–æ
  message: "Too many email requests, please try again later",
};
```

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ email –∞–¥—Ä–µ—Å–æ–≤
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
if (!emailRegex.test(to)) {
  return NextResponse.json({ error: "Invalid email address" }, { status: 400 });
}

// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
if (text && text.length > 10000) {
  return NextResponse.json({ error: "Message too long" }, { status: 400 });
}
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```typescript
// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è email API
console.log(
  `Email API accessed by ${session.user.email} (${session.user.role})`
);
console.log(`Email sent to: ${to}, subject: ${subject}`);
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Production

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM=noreply@yourdomain.com

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
NEXTAUTH_SECRET=your-very-secure-secret
NEXTAUTH_URL=https://yourdomain.com
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS

```typescript
// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ CORS –¥–ª—è email API
const corsOptions = {
  origin: ["https://yourdomain.com"],
  credentials: true,
  optionsSuccessStatus: 200,
};
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Rate Limiting

```typescript
// Rate limiting –¥–ª—è email API
const emailRateLimit = {
  windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
  max: 5, // –º–∞–∫—Å–∏–º—É–º 5 email –≤ 15 –º–∏–Ω—É—Ç
  message: "Email rate limit exceeded",
};
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Email API —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—â–µ–Ω:

- ‚úÖ **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞** –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- ‚úÖ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ä–æ–ª—è–º** - —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–∏—Å—å–º–∞
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∞—Ç–∞–∫
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π** –¥–ª—è –∞—É–¥–∏—Ç–∞
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥—ã** –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–µ–Ω–∞!** üõ°Ô∏è
