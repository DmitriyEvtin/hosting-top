# Среда разработки

## Быстрый старт

Для настройки среды разработки выполните:

```bash
make dev
```

Эта команда автоматически:

- Остановит и удалит существующие контейнеры
- Удалит старые volumes (база данных будет пересоздана)
- Запустит все контейнеры (PostgreSQL, Redis, MinIO, MailHog, Adminer)
- Выполнит миграции
- Заполнит базу тестовыми данными
- Запустит приложение

## Учетные данные для разработки

### Пользователи

- **Администратор**: `admin@dev.ru` / `111111`
- **Пользователь**: `user@dev.ru` / `111111`
- **Модератор**: `moderator@dev.ru` / `111111`
- **Тестовый пользователь**: `test@dev.ru` / `111111`

### Сервисы

- **PostgreSQL**: `localhost:5432`
- **Redis**: `localhost:6379`
- **Adminer**: http://localhost:8080 (автоматическое подключение к PostgreSQL)
- **MailHog**: http://localhost:8025
- **MinIO**: http://localhost:9001

## Команды разработки

### Основные команды

```bash
# Настройка среды разработки + запуск приложения
make dev

# Очистка и пересоздание базы данных
make dev-reset

# Остановка всех сервисов
make dev-down
```

### Работа с базой данных

```bash
# Генерация Prisma клиента
npm run db:generate

# Выполнение миграций
npm run db:migrate

# Заполнение базы тестовыми данными
npm run db:seed-dev

# Сброс базы данных
npm run db:reset

# Просмотр базы данных
npm run db:studio
```

## Особенности среды разработки

### Автоматическое пересоздание базы данных

- База данных **не сохраняется** между перезапусками
- При каждом запуске `npm run dev:setup` база создается заново
- Выполняются все миграции
- Заполняются тестовые данные

### Тестовые данные

- Все пользователи имеют пароль `111111`
- Создается администратор `admin@dev.ru`
- Создаются тестовые пользователи с доменом `@dev.ru`

### Docker контейнеры

- PostgreSQL пересоздается каждый раз
- Redis и MinIO сохраняют данные
- MailHog не сохраняет письма между перезапусками

## Устранение проблем

### База данных не подключается

```bash
# Проверьте статус контейнеров
docker-compose ps

# Перезапустите PostgreSQL
docker-compose restart postgres

# Проверьте логи
docker-compose logs postgres
```

### Ошибки миграций

```bash
# Сбросьте базу данных
npm run db:reset

# Или полностью пересоздайте среду
npm run dev:clean
npm run dev:setup
```

### Проблемы с Prisma

```bash
# Перегенерируйте клиент
npm run db:generate

# Проверьте подключение к базе
npm run db:studio
```

## Структура файлов

```
scripts/
  dev-setup.js          # Скрипт настройки среды разработки

prisma/
  seed-dev.ts         # Сиды для разработки
  seed.ts            # Продакшн сиды
  seed-test.ts       # Тестовые сиды

docker-compose.yml   # Конфигурация Docker (без постоянного хранения БД)
```

## Рекомендации

1. **Всегда используйте `make dev`** для настройки среды
2. **Не коммитьте изменения в базу данных** - она пересоздается каждый раз
3. **Используйте тестовые данные** для разработки
4. **Проверяйте логи** при возникновении проблем
5. **Очищайте среду** при смене веток или больших изменениях
