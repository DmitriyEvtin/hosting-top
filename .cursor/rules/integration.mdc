---
alwaysApply: true
---

# Integration Rules

Comprehensive integration guidelines for Next.js, FSD, Prisma, and Testing working together seamlessly.

## Technology Stack Integration

### Core Technologies
- **Next.js App Router** — Modern React framework with server-side rendering
- **Feature-Sliced Design (FSD)** — Scalable frontend architecture methodology
- **Prisma** — Type-safe database ORM with excellent TypeScript support
- **Testing** — Comprehensive testing strategy with Jest, RTL, and Playwright

### Integration Principles
- **Consistent Architecture** — All technologies follow the same architectural patterns
- **Type Safety** — End-to-end type safety from database to UI
- **Performance First** — Optimize for both development and production performance
- **Developer Experience** — Excellent DX with proper tooling and conventions

## Project Structure Integration

### Unified Project Structure
```
├── prisma/                       # Database schema and migrations
│   ├── schema.prisma             # Database schema
│   ├── migrations/              # Database migrations
│   └── seed.ts                  # Database seeding
├── pages/                        # Empty pages folder (Next.js requirement)
│   └── README.md                 # Explanation why this folder exists
├── src/                          # FSD layers
│   ├── app/                      # Next.js App Router + FSD App layer
│   │   ├── layout.tsx                # Root layout
│   │   ├── page.tsx                  # Home page
│   │   ├── globals.css               # Global styles
│   │   └── providers/                # Global providers
│   ├── pages/                    # FSD Pages layer
│   ├── widgets/                  # Widgets layer
│   ├── features/                 # Features layer
│   ├── entities/                 # Entities layer
│   └── shared/                   # Shared layer
│       ├── ui/                   # Shared UI components
│       ├── api/                  # Shared API utilities
│       │   └── database/          # Prisma client and database utilities
│       ├── lib/                  # Shared utilities
│       │   └── prisma/           # Prisma-specific utilities
│       └── config/               # Shared configuration
├── tests/                        # Test files
│   ├── e2e/                     # End-to-end tests
│   ├── __mocks__/               # Test mocks
│   └── utils/                   # Test utilities
└── docs/                        # Documentation
```

## Next.js + FSD Integration

### App Router as FSD App Layer
- **`app/` directory** serves as both Next.js App Router and FSD App layer
- **Route files** (layout.tsx, page.tsx) are thin wrappers that import from FSD layers
- **Global providers** are organized in `app/providers/`
- **Metadata** is configured at the app level

### FSD Layer Integration with Next.js
- **Pages layer** — Next.js pages import from FSD pages layer
- **Widgets layer** — Reusable UI blocks used across pages
- **Features layer** — Business features with their own API and state
- **Entities layer** — Business entities with Prisma integration
- **Shared layer** — Common utilities, components, and configurations

### Example Integration
```typescript
// app/page.tsx (Next.js App Router)
import { HomePage } from '@/pages/home'

export default function Page() {
  return <HomePage />
}

// src/pages/home/ui/home-page.tsx (FSD Pages layer)
import { ProductList } from '@/widgets/product-list'
import { SearchFeature } from '@/features/search'

export function HomePage() {
  return (
    <div>
      <SearchFeature />
      <ProductList />
    </div>
  )
}
```

## Prisma + FSD Integration

### Database Layer Organization
- **`shared/api/database/`** — Prisma client configuration
- **`entities/*/api/`** — Entity-specific database operations
- **`features/*/api/`** — Feature-specific database operations
- **`shared/lib/prisma/`** — Prisma utilities and helpers

### Entity-Repository Pattern
```typescript
// src/entities/user/api/user-repository.ts
import { prisma } from '@/shared/api/database/prisma-client'
import { User, Prisma } from '@prisma/client'

export class UserRepository {
  static async create(data: Prisma.UserCreateInput): Promise<User> {
    return await prisma.user.create({ data })
  }

  static async findById(id: string): Promise<User | null> {
    return await prisma.user.findUnique({ where: { id } })
  }
}

// src/entities/user/model/user-store.ts
import { UserRepository } from '../api/user-repository'

export class UserStore {
  private users: User[] = []

  async loadUsers() {
    this.users = await UserRepository.findMany({})
  }

  getUsers() {
    return this.users
  }
}
```

## Testing Integration

### FSD Testing Strategy
- **Unit tests** — Test individual components and utilities
- **Integration tests** — Test component interactions within FSD layers
- **E2E tests** — Test complete user journeys across pages

### Testing Setup
```typescript
// src/test/setup.ts
import { setupServer } from 'msw/node'
import { handlers } from './mocks/handlers'

export const server = setupServer(...handlers)

beforeAll(() => server.listen())
afterEach(() => server.resetHandlers())
afterAll(() => server.close())
```

### FSD Layer Testing
```typescript
// src/entities/user/api/__tests__/user-repository.test.ts
import { UserRepository } from '../user-repository'
import { prisma } from '@/shared/api/database/prisma-client'

describe('UserRepository', () => {
  it('should create a user', async () => {
    const userData = { email: 'test@example.com', name: 'Test User' }
    const user = await UserRepository.create(userData)
    
    expect(user).toBeDefined()
    expect(user.email).toBe(userData.email)
  })
})
```

## Type Safety Integration

### End-to-End Type Safety
- **Prisma types** — Generated from database schema
- **API types** — Shared between frontend and backend
- **Component props** — Typed interfaces for all components
- **State types** — Typed state management

### Type Sharing
```typescript
// src/shared/api/types/user.ts
export interface User {
  id: string
  email: string
  name: string
  createdAt: Date
  updatedAt: Date
}

// src/entities/user/model/user-store.ts
import { User } from '@/shared/api/types/user'

export class UserStore {
  private users: User[] = []
  // ... implementation
}
```

## Performance Integration

### Next.js Performance
- **Server Components** — Use for data fetching and SEO
- **Client Components** — Use for interactivity and state
- **Code splitting** — Automatic with Next.js App Router
- **Image optimization** — Next.js Image component

### FSD Performance
- **Lazy loading** — Load components on demand
- **Bundle splitting** — Separate bundles for different layers
- **Tree shaking** — Remove unused code
- **Caching** — Implement proper caching strategies

### Prisma Performance
- **Query optimization** — Select only needed fields
- **Connection pooling** — Configure proper connection pooling
- **Caching** — Cache frequently accessed data
- **Indexes** — Add database indexes for performance

## Development Workflow Integration

### Development Commands
```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:e2e": "playwright test",
    "db:generate": "prisma generate",
    "db:push": "prisma db push",
    "db:migrate": "prisma migrate dev",
    "db:seed": "prisma db seed"
  }
}
```

### Code Quality Tools
- **ESLint** — Linting for code quality
- **Prettier** — Code formatting
- **TypeScript** — Type checking
- **FSD Linter** — Architecture validation
- **Husky** — Git hooks for quality gates

## Deployment Integration

### Production Considerations
- **Database migrations** — Run migrations on deployment
- **Environment variables** — Secure configuration management
- **Performance monitoring** — Monitor application performance
- **Error tracking** — Track and monitor errors
- **Logging** — Comprehensive logging strategy

### CI/CD Pipeline
```yaml
# .github/workflows/deploy.yml
name: Deploy
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run test
      - run: npm run build
      - run: npx prisma migrate deploy
      - run: npm run start
```

## Best Practices Integration

### Code Organization
- **Consistent naming** — Use consistent naming conventions
- **Clear boundaries** — Maintain clear layer boundaries
- **Single responsibility** — Each module has one responsibility
- **Dependency management** — Manage dependencies properly

### Error Handling
- **Global error handling** — Implement global error boundaries
- **API error handling** — Handle API errors gracefully
- **Database error handling** — Handle database errors properly
- **User feedback** — Provide meaningful error messages

### Security
- **Input validation** — Validate all inputs
- **Authentication** — Implement proper authentication
- **Authorization** — Implement proper authorization
- **Data protection** — Protect sensitive data

## Documentation Integration

### Architecture Documentation
- **FSD structure** — Document FSD layer organization
- **API documentation** — Document API endpoints
- **Database schema** — Document database structure
- **Testing strategy** — Document testing approach

### Development Documentation
- **Setup guide** — How to set up the project
- **Development workflow** — How to develop features
- **Deployment guide** — How to deploy the application
- **Troubleshooting** — Common issues and solutions

Remember: The key to successful integration is maintaining consistency across all technologies while leveraging the strengths of each tool in the stack.