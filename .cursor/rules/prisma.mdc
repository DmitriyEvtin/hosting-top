---
alwaysApply: true
---

# Prisma Development Rules

Follow Prisma best practices and conventions for building modern database-driven applications with Next.js and FSD architecture.

## Prisma Integration with FSD Architecture

### Database Layer Organization
- **`shared/api/database/`** — Prisma client configuration and database utilities
- **`shared/lib/prisma/`** — Prisma-specific utilities and helpers
- **`entities/*/api/`** — Entity-specific database operations
- **`features/*/api/`** — Feature-specific database operations

### Project Structure (Prisma + FSD + Next.js)

**IMPORTANT**: Only create folders when you actually need them. Don't create empty directories for layers or slices that aren't being used yet. Start with the minimal structure and grow it organically as your project develops.

#### Minimal Starting Structure (Prisma + Next.js App Router + FSD)
```
├── prisma/                       # Prisma configuration
│   ├── schema.prisma             # Database schema
│   ├── migrations/              # Database migrations
│   └── seed.ts                  # Database seeding
├── pages/                        # Empty pages folder (Next.js requirement)
│   └── README.md                 # Explanation why this folder exists
└── src/                          # FSD layers and Next app
    ├── ...
```

## Prisma Schema Design

### Schema Organization
- **Single schema file** — Keep all models in `prisma/schema.prisma`
- **Logical grouping** — Group related models together
- **Clear naming** — Use descriptive, consistent model and field names
- **Proper relationships** — Define clear relationships between models

### Model Design Principles
- **Primary keys** — Always define explicit primary keys
- **Timestamps** — Include `createdAt` and `updatedAt` for audit trails
- **Soft deletes** — Use `deletedAt` for soft delete functionality
- **Indexes** — Add indexes for frequently queried fields
- **Constraints** — Use database constraints for data integrity

## Prisma Client Configuration

### Client Setup
- **Singleton pattern** — Use singleton pattern for Prisma client
- **Connection pooling** — Configure proper connection pooling
- **Error handling** — Implement comprehensive error handling
- **Type safety** — Leverage Prisma's generated types

## Entity-Specific Database Operations

### Entity API Structure
- **CRUD operations** — Create, Read, Update, Delete operations
- **Query builders** — Reusable query building functions
- **Validation** — Input validation and sanitization
- **Error handling** — Proper error handling and logging

## Feature-Specific Database Operations

### Feature API Structure
- **Business logic** — Feature-specific database operations
- **Complex queries** — Multi-table queries and aggregations
- **Transactions** — Database transactions for complex operations
- **Caching** — Query result caching strategies

## Database Migrations

### Migration Strategy
- **Incremental migrations** — Small, incremental database changes
- **Backward compatibility** — Maintain backward compatibility when possible
- **Data migration** — Handle data transformations in migrations
- **Rollback strategy** — Plan for migration rollbacks

### Migration Best Practices
- **Review migrations** — Always review generated migrations
- **Test migrations** — Test migrations on development data
- **Backup strategy** — Backup database before major migrations
- **Documentation** — Document complex migrations

## Database Seeding

### Seed Strategy
- **Development data** — Create realistic development data
- **Test data** — Generate test data for different scenarios
- **Production data** — Handle production data seeding carefully
- **Data relationships** — Maintain proper data relationships

## Error Handling and Logging

### Error Handling Strategy
- **Database errors** — Handle Prisma-specific errors
- **Connection errors** — Handle database connection issues
- **Validation errors** — Handle data validation errors
- **Transaction errors** — Handle transaction rollbacks

## Performance Optimization

### Query Optimization
- **Select specific fields** — Only select needed fields
- **Use includes wisely** — Be selective with includes
- **Pagination** — Implement proper pagination
- **Indexes** — Add database indexes for performance

### Caching Strategy
- **Query result caching** — Cache frequently accessed data
- **Connection pooling** — Use connection pooling
- **Query optimization** — Optimize complex queries
- **Database monitoring** — Monitor database performance

## Testing Database Operations

### Testing Strategy
- **Unit tests** — Test individual database operations
- **Integration tests** — Test database operations with real database
- **Test data** — Use test-specific data
- **Database cleanup** — Clean up test data after tests

## Environment Configuration

### Environment Variables
- **Database URL** — Configure database connection
- **Environment-specific settings** — Different settings for different environments
- **Security** — Secure sensitive database credentials
- **Validation** — Validate environment variables

## Prisma Code Review Checklist

### Architecture Validation
- [ ] Database operations follow FSD hierarchy
- [ ] Entity APIs are properly organized
- [ ] Feature APIs contain business logic
- [ ] Shared database utilities are reusable
- [ ] Proper error handling implemented

### Performance Checklist
- [ ] Queries are optimized
- [ ] Proper pagination implemented
- [ ] Database indexes are appropriate
- [ ] Connection pooling configured
- [ ] Caching strategy implemented

### Security Checklist
- [ ] Input validation implemented
- [ ] SQL injection prevention
- [ ] Proper error handling
- [ ] Sensitive data protection
- [ ] Access control implemented

### Testing Checklist
- [ ] Unit tests for database operations
- [ ] Integration tests with real database
- [ ] Test data cleanup
- [ ] Error scenario testing
- [ ] Performance testing

## Prisma Best Practices

### Development Workflow
1. **Design schema** — Plan database schema before implementation
2. **Generate migrations** — Use Prisma migrations for schema changes
3. **Test locally** — Test changes in development environment
4. **Review changes** — Review migrations before applying
5. **Deploy carefully** — Deploy migrations with proper monitoring

### Maintenance Guidelines
- **Regular backups** — Backup database regularly
- **Monitor performance** — Monitor database performance
- **Update dependencies** — Keep Prisma and database drivers updated
- **Documentation** — Document complex database operations
- **Security updates** — Apply security updates promptly

Remember: Prisma provides powerful database access capabilities. Use these features appropriately within the FSD architecture to create maintainable, scalable, and secure database-driven applications.